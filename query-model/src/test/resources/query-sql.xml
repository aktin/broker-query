<?xml version="1.0"?>
<sql datasource="java:/WorkplaceDemoDS">
	<!-- xmlns="http://aktin.org/ns/dwh" xsi:type="dwh:sqlt"  -->
	<temporary-table name="temp-patients"/>
	
	<source type="application/sql" date-format="...">
	<![CDATA[
			CREATE TEMPORARY TABLE temp_patients(id, sex);
			CREATE TEMPORARY TABLE temp_encounters(id, patient, start);
			CREATE TEMPORARY TABLE temp_diag(patient, encounter, diag);
			-- TODO ddl with placeholders
			INSERT INTO temp_patients SELECT x,y FROM t WHERE z > '${data.start}' AND z < '${data.end}';
			
			]]><!-- 
			Commands must end with ";" at end of line. 
			Comments must start with two dashes at beginning of line
			-->
	</source>
	<anonymize>
		<key table="temp_patients" column="id" />
		<ref table="temp_encounters" column="patient" />
		<ref table="temp_diag" column="patient" />
		<!-- PRODUCES: CREATE TEMPORARY TABLE anon_map AS SELECT id FROM temp_patients 
			WHERE FALSE; ALTER TABLE anon_map ADD COLUMN target(INTEGER NOT NULL AUTO_INCREMENT); 
			INSERT INTO anon_map(id) (SELECT DISTINCT id FROM temp_patients); ALTER TABLE 
			temp_patients ADD COLUMN a_id(INTEGER NOT NULL); UPDATE temp_patients SET 
			a_id=map.target WHERE id=map.id (FROM anon_Map map); ALTER TABLE temp_patients 
			DROP COLUMN id; ... also for ref tables -->
	</anonymize>
	<anonymize>
		<key table="temp_encounters" column="id" />
		<ref table="temp_diag" column="encounter" />
	</anonymize>
	<export table="temp_patients" destination="patients.txt" />
	<export table="temp_encounters" destination="encounters.txt" />
	<export table="temp_diag" destination="diag.txt" />
</sql>